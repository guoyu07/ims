define("page/edit",["lib/jquery","module/Editor","util/jquery.tmpl"],function(e){"use strict";var t,i=e("lib/jquery"),n=e("module/Editor");return e("util/jquery.tmpl"),t={data:{choices:[]},init:function(e,r){var a,s=t;i.extend(s,r),"string"===i.type(e)?s.previewArea=i("#"+e):s.previewArea=e,a=s.previewArea,s._previewBody=a.find(".preview-body"),s._previewAnswer=a.find(".preview-answer"),s._previewAnalysis=a.find(".preview-analysis"),s._latexBody=a.find(".latex-body"),s._latexAnswer=a.find(".latex-answer"),s._subject=a.find(".subject"),s._questionType=a.find(".question-type"),s._grade=a.find(".grade"),s._noAnswer=a.find(".no-answer"),i.template("questionTemplate",s.tmpl),s.editorBody=new n(s.editArea.find(".edit-body"),{submitCall:function(){var e=this;e.getContent(function(t){t.content?(e.disable(),t.choices&&(s.data.choices=t.choices),s.data.description=t.description,s._previewBody.html(t.content),s._latexBody.html(t.latex)):alert(e.submit.data("title")+"不能为空")},{withLatex:1})}}),s.editorAnswer=new n(s.editArea.find(".edit-answer"),{submitCall:function(e){var t=this;t.getContent(function(e){e.content?(t.disable(),s._previewAnswer.html(e.content),s._latexAnswer.html(e.latex)):alert(t.submit.data("title")+"不能为空")},{withLatex:1})}}),s.editorAnalysis=new n(s.editArea.find(".edit-analysis"),{submitCall:function(e){var t=this;t.getContent(function(e){e.content?(t.disable(),s._previewAnalysis.html(e.content)):alert(t.submit.data("title")+"不能为空")})}}),s.addEvent()},addEvent:function(){var e=t;e.previewArea.on("click",".photo-frame img",function(e){window.open(i(this).attr("src"),"newwindow","alwaysRaised=yes,z-look=yes")}).on("click",".submit",function(t){var n,r,a,s,o,l,d,u={};if(u.content=e._previewBody.html(),!u.content)return void alert("请输入问题描述后再提交");if(u.realType=e._questionType.val(),!u.realType)return void alert("请选择题型后再提交");if("1"===u.realType||"2"===u.realType){if(n=e.data.choices.length,0===n)return void alert("选择题必须添加选项");if(u.selectOptionArray=e.data.choices.map(function(e){return window.encodeURIComponent(e)}).join(),u.selectContent=e.data.description,!u.selectContent)return void alert("选择题必须输入题干")}if(void 0!==e.complete?u.complete=1:u.complete=e._noAnswer.data("answer"),1===u.complete){if(u.answer=e._previewAnswer.html().trim(),!u.answer)return void alert("请输入题目解答后再提交");if("1"===u.realType||"2"===u.realType)if(u.answer=e._previewAnswer.text().trim(),"1"===u.realType){if(a=String.fromCharCode(64+n),r=new RegExp("^[A-"+a+"]$"),!r.test(u.answer))return void alert("单选题只能录入一个答案")}else{if(a=String.fromCharCode(64+n),s=u.answer.split(""),d=s.length,d>n)return void alert("该多选题最多只能有"+n+"个答案");for(o="A",l=0;d>l;++l){if(o>a)return void alert("请输入合法的多选题答案");if(r=new RegExp("^["+o+"-"+a+"]$"),!r.test(s[l]))return void alert("请输入合法的多选题答案");o=String.fromCharCode(s[l].charCodeAt(0)+1)}}if(u.solution=e._previewAnalysis.html(),!u.solution)return void alert("请输入解题思路后再提交");u.answerLatex=e._latexAnswer.html()}else u.answer="",u.answerLatex="",u.solution="";return u.subject=e._subject.val(),u.subject?(u.realLearnPhase=e._grade.val(),u.realLearnPhase?(u.latex=e._latexBody.html(),u.knowledge="知识点",u.target="",e.extend&&(u=e.extend(u)),void i.ajax({url:e.submitUrl,type:"POST",data:u,dataType:"json",success:function(t){alert(t.msg),0===t.status&&e.submitCall&&e.submitCall(t)},error:function(){alert("提交异常，请稍后重试！")}})):void alert("请选择学段后再提交")):void alert("请选择学科后再提交")}).on("click",".no-answer",function(t){var n=i(this);1===n.data("answer")?(e._previewAnswer.empty(),e.editorAnswer.disable({text:"无需题目解答",submitStatus:"disabled"}),e._previewAnalysis.empty(),e.editorAnalysis.disable({text:"无需解题思路",submitStatus:"disabled"}),n.text("录入答案").data("answer",0)):(e.editorAnswer.enable(),e.editorAnalysis.enable(),n.text("不录答案").data("answer",1))})}},{init:t.init}});